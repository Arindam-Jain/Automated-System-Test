/*
 * handler for filtering virtual fields by READ
 */

const _filter = (columns, target) => {
  let i = 0
  while (i < columns.length) {
    const col = columns[i]
    if (col.ref) {
      const element = target.elements[col.ref[0]]
      if (element && element.virtual) {
        columns.splice(columns.indexOf(col), 1)
        i--
      }
      if (col.expand && element && element.isAssociation) {
        _filter(col.expand, element._target)
      }
    }
    i++
  }
}

const filterVirtual = req => {
  if (typeof req.query === 'string' || !req.target || req.target._unresolved) {
    return
  }

  if (req.query.SELECT && !req.query.SELECT.columns) {
    return
  }

  _filter(req.query.SELECT.columns, req.target)
}

filterVirtual._initial = true

module.exports = filterVirtual
